<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AzureBot Web</title>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#0f172a}
    #wrap{display:flex;flex-direction:column;height:100%}
    header{color:#fff;padding:8px 12px;font:600 14px/1.4 ui-sans-serif}
    header a{color:#60a5fa;margin-left:12px;text-decoration:none}
    #webchat{flex:1;max-width:900px;margin:0 auto 8px;background:#111827;border-radius:16px}
    .status{color:#94a3b8;font:500 12px/1.4 ui-sans-serif;padding:0 12px 8px}
  </style>
</head>
<body>
<div id="wrap">
    <header>üß† AzureBot ‚Äî interface web</header>
  <div class="status" id="status">Connexion en cours‚Ä¶</div>
  <div class="status" id="upStatus"></div>
  <div id="webchat" role="main"></div>
</div>

<script>
(async function () {
  const status = document.getElementById('status');
  const upStatus = document.getElementById('upStatus');

  // ENDPOINTS (mets √† jour si besoin)
  const TOKEN_URL = 'https://func-agent-ia-atced9dyergaeqe5.canadacentral-01.azurewebsites.net/api/token';
  const SAS_URL   = 'https://func-agent-ia-atced9dyergaeqe5.canadacentral-01.azurewebsites.net/api/get_upload_sas';

  // Identifiant user pour tracer les blobs (cot√© serveur)
  const userID = 'web-' + Math.random().toString(36).slice(2);

  let dl;
  let store;

  async function uploadAndSend(files, userText) {
    const fileList = Array.from(files || []);
    if (!fileList.length) return;

    const allowed = ['application/pdf','image/png','image/jpeg','image/jpg','image/webp'];
    for (const f of fileList) {
      if (!allowed.some(a => f.type === a || (a === 'application/pdf' && f.name.toLowerCase().endsWith('.pdf')))) {
        upStatus.textContent = `Type non support√©: ${f.name}`;
        return;
      }
      if (f.size > 25 * 1024 * 1024) {
        upStatus.textContent = `Fichier trop volumineux (>25 Mo): ${f.name}`;
        return;
      }
    }

    upStatus.textContent = 'Pr√©paration des SAS‚Ä¶';

    const sasResp = await fetch(SAS_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: userID,
        files: fileList.map(f => ({ filename: f.name, contentType: f.type }))
      })
    });
    if (!sasResp.ok) { upStatus.textContent = '‚ùå Erreur SAS'; return; }
    const sas = await sasResp.json();

    const blobs = [];
    for (let i = 0; i < sas.uploads.length; i++) {
      const f = fileList[i];
      const u = sas.uploads[i];
      upStatus.textContent = `Upload ${i+1}/${fileList.length}‚Ä¶`;

      const put = await fetch(u.putUrl, {
        method: 'PUT',
        headers: { 'x-ms-blob-type': 'BlockBlob', 'Content-Type': f.type || 'application/octet-stream' },
        body: f
      });
      if (!put.ok) { upStatus.textContent = `‚ùå Upload √©chou√©: ${f.name}`; return; }

      blobs.push({ blobUrl: u.blobUrl, contentType: f.type });
    }

    dl.postActivity({
      type: 'event',
      name: 'files_uploaded',
      from: { id: userID },
      value: { blobs, userText }
    }).subscribe({
      next: () => { upStatus.textContent = 'Fichiers envoy√©s pour analyse.'; },
      error: (e) => { console.error(e); upStatus.textContent = '‚ùå Envoi event √©chou√©.'; }
    });

    store.dispatch({ type: 'WEB_CHAT/SET_SEND_BOX', payload: { text: '', attachments: [] } });
  }

  try {
    const res = await fetch(TOKEN_URL, { method: 'GET' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const { token } = await res.json();
    status.textContent = 'Connect√© √† Direct Line.';

    store = window.WebChat.createStore({}, ({ dispatch }) => next => action => {
      if (action.type === 'WEB_CHAT/SEND_FILES') {
        uploadAndSend(action.payload.files, action.payload.text);
        return;
      }
      return next(action);
    });

    dl = window.WebChat.createDirectLine({ token });

    window.WebChat.renderWebChat(
      {
        directLine: dl,
        locale: 'fr-FR',
        userID,
        store,
        styleOptions: { bubbleBorderRadius: 10 }
      },
      document.getElementById('webchat')
    );

  } catch (e) {
    console.error(e);
    status.textContent = '‚ùå Erreur pour obtenir le token (voir console).';
  }
})();
</script>
</body>
</html>
