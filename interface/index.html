<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AzureBot Web</title>
  <script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
  <style>
    html,body{height:100%;margin:0;background:#0f172a}
    #wrap{display:flex;flex-direction:column;height:100%}
    header{color:#fff;padding:8px 12px;font:600 14px/1.4 ui-sans-serif}
    header a{color:#60a5fa;margin-left:12px;text-decoration:none}
    #webchat{flex:1;max-width:900px;margin:0 auto 8px;background:#111827;border-radius:16px}
    .status{color:#94a3b8;font:500 12px/1.4 ui-sans-serif;padding:0 12px 8px}
  </style>
</head>
<body>
<div id="wrap">
    <header>üß† AzureBot ‚Äî interface web</header>
  <div class="status" id="status">Connexion en cours‚Ä¶</div>
  <div class="status" id="upStatus"></div>
  <div style="max-width:900px;margin:0 auto 8px;padding:8px 0 0 0;">
    <label style="color:#cbd5e1;font:500 12px ui-sans-serif;display:block;margin:0 0 6px 0;">Analyser des fichiers (PDF, PNG, JPG, WEBP)</label>
    <input id="fileInput" type="file" multiple accept=".pdf,image/*" style="color:#cbd5e1" />
  </div>
  <div id="webchat" role="main"></div>
</div>

<script>
(async function () {
  const status = document.getElementById('status');
  const upStatus = document.getElementById('upStatus');

  // ENDPOINTS (mets √† jour si besoin)
  const TOKEN_URL = 'https://func-agent-ia-atced9dyergaeqe5.canadacentral-01.azurewebsites.net/api/token';
  const SAS_URL   = 'https://func-agent-ia-atced9dyergaeqe5.canadacentral-01.azurewebsites.net/api/get_upload_sas';

  // Identifiant user pour tracer les blobs (cot√© serveur)
  const userID = 'web-' + Math.random().toString(36).slice(2);

  let dl;
  let store;

  async function uploadAndSend(files, userMessage) {
    const fileList = Array.from(files || []);
    if (!fileList.length) return;

    const isPdf = (f) => (f.type === 'application/pdf') || f.name.toLowerCase().endsWith('.pdf');
    const isImg = (f) => (f.type.startsWith('image/')) || /\.(png|jpg|jpeg|webp)$/i.test(f.name);
    for (const f of fileList) {
      if (!(isPdf(f) || isImg(f))) {
        upStatus.textContent = `Type non support√©: ${f.name}`;
        console.warn('Unsupported file type', f);
        return;
      }
      if (f.size > 25 * 1024 * 1024) {
        upStatus.textContent = `Fichier trop volumineux (>25 Mo): ${f.name}`;
        return;
      }
    }

    upStatus.textContent = 'Pr√©paration des SAS‚Ä¶';

    let sas;
    try {
      const sasResp = await fetch(SAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: userID,
          files: fileList.map(f => ({ filename: f.name, contentType: f.type }))
        })
      });
      if (!sasResp.ok) {
        const detail = await sasResp.text();
        upStatus.textContent = `‚ùå Erreur SAS (${sasResp.status})`;
        console.error('SAS error:', sasResp.status, detail);
        return;
      }
      sas = await sasResp.json();
    } catch (e) {
      upStatus.textContent = '‚ùå Exception lors de la requ√™te SAS (voir console)';
      console.error('SAS exception', e);
      return;
    }

    const blobs = [];
    for (let i = 0; i < sas.uploads.length; i++) {
      const f = fileList[i];
      const u = sas.uploads[i];
      upStatus.textContent = `Upload ${i+1}/${fileList.length}‚Ä¶`;

      const put = await fetch(u.putUrl, {
        method: 'PUT',
        headers: { 'x-ms-blob-type': 'BlockBlob', 'Content-Type': f.type || 'application/octet-stream' },
        body: f
      });
      if (!put.ok) {
        const detail = await put.text();
        upStatus.textContent = `‚ùå Upload √©chou√©: ${f.name}`;
        console.error('Upload error', put.status, detail);
        return;
      }

      blobs.push({ blobUrl: u.blobUrl, contentType: f.type });
    }

    dl.postActivity({
      type: 'event',
      name: 'files_uploaded',
      from: { id: userID },
      value: { blobs, message: (userMessage || '').trim() }
    }).subscribe({
      next: () => { upStatus.textContent = 'Fichiers envoy√©s pour analyse.'; },
      error: (e) => { console.error('postActivity error', e); upStatus.textContent = '‚ùå Envoi event √©chou√©.'; }
    });

    store.dispatch({ type: 'WEB_CHAT/SET_SEND_BOX', payload: { attachments: [] } });
    // Clear the text input now that we sent it alongside files
    store.dispatch({ type: 'WEB_CHAT/SET_SEND_BOX', payload: { text: '' } });
  }

  try {
    const res = await fetch(`${TOKEN_URL}?userId=${encodeURIComponent(userID)}`, { method: 'GET' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const { token } = await res.json();
    status.textContent = 'Connect√© √† Direct Line.';

    store = window.WebChat.createStore({}, ({ dispatch, getState }) => next => action => {
      if (action.type === 'WEB_CHAT/SEND_FILES') {
        const state = (typeof getState === 'function') ? getState() : {};
        const userMessage = (state.sendBoxValue || '').trim();
        uploadAndSend(action.payload.files, userMessage);
        return; // stop default attachment sending
      }
      return next(action);
    });

    dl = window.WebChat.createDirectLine({ token });

    window.WebChat.renderWebChat(
      {
        directLine: dl,
        locale: 'fr-FR',
        userID,
        store,
        styleOptions: { bubbleBorderRadius: 10, hideUploadButton: true }
      },
      document.getElementById('webchat')
    );

    // Brancher notre input fichier custom pour d√©clencher l'upload
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', () => {
      const state = store.getState ? store.getState() : {};
      const userMessage = (state.sendBoxValue || '').trim();
      uploadAndSend(fileInput.files, userMessage);
      fileInput.value = '';
    });

  } catch (e) {
    console.error(e);
    status.textContent = '‚ùå Erreur pour obtenir le token (voir console).';
  }
})();
</script>
</body>
</html>
